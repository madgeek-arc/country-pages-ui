<form [formGroup]="form">
<div *ngIf="fieldData.field.typeInfo.multiplicity; else noMultiplicity">
  <div *ngFor="let control of fieldAsFormArray().controls; let i=index">
    <div [formGroupName]="i" class="uk-margin-bottom formGroupElement uk-width-9-10 uk-display-inline-block">
      <div *ngFor="let control of fieldData?.subFieldGroups; let j=index">
        <div class="uk-margin-bottom">
          <label class="uk-form-label uk-text-right" [attr.for]="control.field.name + ' ' + i">
            {{control.field.label + (control.field.form.mandatory ? ' (*)' : '')}}
          </label>
          <div class="uk-form-description uk-margin-top uk-width-9-10">
            {{control.field.form.description}}
          </div>
          <div *ngIf="control.field.typeInfo.type === 'composite'">
            <app-composite-field [fieldData]="control" [subVocabularies]="subVocabularies" [vocabularies]="vocabularies"
                                 [position]="i" (handleBitSets)="handleBitsetOfChildren($event)"
                                 (handleBitSetsOfComposite)="handleCompositeBitsetOfChildren($event)">
            </app-composite-field>
          </div>
          <div *ngIf="control.field.typeInfo.type === 'vocabulary'" class="uk-form-controls uk-margin-medium-top">
            <ng-select class="uk-width-9-10" [id]="control.field.name"
                       [ngClass]="{'uk-form-danger': checkFormArrayValidity(control.field.parent, i, this.editMode, control.field.name)}"
                       [items]="getCompositeVocabularyItems(fieldData, j, i)"
                       (change)="onCompositeChange(fieldData, j, i); updateBitSetOfComposite(fieldData, j); unsavedChangesPrompt();"
                       bindLabel="name"
                       bindValue="id"
                       clearAllText="Clear"
                       [formControlName]="control.field.name">
            </ng-select>
            <div class="uk-margin-small-top">
              <i><small>{{control.field.form.suggestion}}</small></i>
            </div>
          </div>
          <div *ngIf="control.field.typeInfo.type === 'string' || control.field.typeInfo.type === 'email'|| control.field.typeInfo.type === 'phone'
                      || control.field.typeInfo.type === 'url'">
            <app-string-url-email-field [fieldData]="control" [position]="i"
                                        (handleBitSets)="handleBitsetOfChildren($event)"
                                        (handleBitSetsOfComposite)="handleCompositeBitsetOfChildren($event)">
            </app-string-url-email-field>
          </div>
          <div *ngIf="control.field.typeInfo.type === 'largeText'">
            <textarea [id]="control.field.name" class="uk-textarea uk-width-9-10"
                      [formControlName]="control.field.name"
                      (input)="updateBitSetOfComposite(fieldData, j); unsavedChangesPrompt()"
                      [ngClass]="{'uk-form-danger': checkFormArrayValidity(control.field.parent, i, this.editMode, control.field.name)}">
            </textarea>
          </div>
          <div *ngIf="control.field.typeInfo.type === 'boolean'">
            <div *ngIf="control.field.typeInfo.multiplicity; else noMultiplicity;" [formArrayName]="control.field.name">
              <!--To add multiplicity if needed-->
            </div>
            <ng-template #noMultiplicity>
              <label>
                <input class="uk-radio" type="radio" [formControlName]="control.field.name" [value]="true"
                       (input)="updateBitSetOfComposite(fieldData, j); unsavedChangesPrompt()" [name]="control.field.name"
                       [ngClass]="{'uk-form-danger': checkFormArrayValidity(control.field.parent, i, this.editMode, control.field.name) }"/>&nbsp;Yes&nbsp;
              </label>
              <label>
                <input class="uk-radio" type="radio" [formControlName]="control.field.name" [value]="false"
                       (input)="updateBitSetOfComposite(fieldData, j); unsavedChangesPrompt()" [name]="control.field.name"
                       [ngClass]="{'uk-form-danger': checkFormArrayValidity(control.field.parent, i, this.editMode, control.field.name) }"/>&nbsp;&nbsp;No&nbsp;
              </label>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
    <a *ngIf="fieldAsFormArray().length > 1" class="remove-element uk-padding-small uk-display-inline-block"
       (click)="remove(i); updateBitSetOfComposite(fieldData, i); unsavedChangesPrompt();">
      <i class="fa fa-times" aria-hidden="true"></i>
    </a>
  </div>
  <div class="uk-width-9-10 uk-text-center uk-margin-top">
    <a class="add-new-element" (click)="pushComposite(fieldData.subFieldGroups)">
      <i class="fa fa-plus" aria-hidden="true"></i> Add {{fieldData.field.label}}
    </a>
  </div>
</div>

<ng-template #noMultiplicity>
  <div  class="uk-margin-bottom formGroupElement uk-width-9-10 uk-display-inline-block">
    <div *ngFor="let control of fieldData?.subFieldGroups; let j=index">
      <div class="uk-margin-bottom">
        <label class="uk-form-label uk-text-right" [attr.for]="control.field.name">
          {{control.field.label + (control.field.form.mandatory ? ' (*)' : '')}}
        </label>
        <div class="uk-form-description uk-margin-top uk-width-9-10">
          {{control.field.form.description}}
        </div>

        <div *ngIf="control.field.typeInfo.type === 'composite'">
          <app-composite-field [fieldData]="control" [subVocabularies]="subVocabularies" [vocabularies]="vocabularies"
                               (handleBitSets)="handleBitsetOfChildren($event)"
                               (handleBitSetsOfComposite)="handleCompositeBitsetOfChildren($event)">
          </app-composite-field>
        </div>

        <div *ngIf="control.field.typeInfo.type === 'vocabulary'"
             class="uk-form-controls uk-margin-medium-top">
          <ng-select class="uk-width-9-10" [id]="control.field.name"
                     [ngClass]="{'uk-form-danger': checkFormValidity(control.field.parent + '.' + control.field.name, this.editMode)}"
                     [items]="getCompositeVocabularyItems(fieldData, j)"
                     (change)="unsavedChangesPrompt(); onCompositeChange(fieldData, j); updateBitSetOfComposite(fieldData, j)"
                     bindLabel="name"
                     bindValue="id"
                     clearAllText="Clear"
                     [formControlName]="control.field.name">
          </ng-select>
          <div class="uk-margin-small-top">
            <i><small>{{control.field.form.suggestion}}</small></i>
          </div>
        </div>

        <div *ngIf="control.field.typeInfo.type === 'string' || control.field.typeInfo.type === 'email' || control.field.typeInfo.type === 'email'
                    || control.field.typeInfo.type === 'phone'">
          <app-string-url-email-field [fieldData]="control"
                                      (handleBitSets)="handleBitsetOfChildren($event)"
                                      (handleBitSetsOfComposite)="handleCompositeBitsetOfChildren($event)">
          </app-string-url-email-field>
        </div>
      </div>
    </div>
  </div>
</ng-template>
</form>
<!--<pre>{{fieldData | json}}</pre>-->
